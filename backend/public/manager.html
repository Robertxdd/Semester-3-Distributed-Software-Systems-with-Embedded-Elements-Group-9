<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Desk Supervisor – Manager</title>

  <link rel="stylesheet" href="styles.css">
  <script src="theme.js" defer></script>
</head>

<body>
  <div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">S</div>
        <div>Smart Desk Supervisor</div>
      </div>

      <nav class="nav">
        <a href="deskcontrol.html">My Desk</a>
        <a href="healthreport.html">Health & Reports</a>
        <a href="settings.html">Admin - Settings</a>
        <a href="manager.html" class="active">Manager</a>
        <a href="user.html">User</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">

      <!-- Topbar -->
      <header class="topbar">
        <div>
          <h1>Manager view</h1>
          <p class="subtitle">Admin-only area with desk registry and fleet actions.</p>
        </div>

        <div class="topbar-actions">
          <button class="btn secondary" data-theme-toggle>Toggle theme</button>
          <button class="btn secondary" data-logout>Logout</button>
        </div>
      </header>

      <!-- Desk registry -->
      <section class="section card">
        <header class="title"><h3>Registered desks</h3></header>

        <div class="toolbar">
          <p id="manager-status">Loading desks…</p>
          <button class="btn secondary" id="btn-refresh">Refresh</button>
        </div>

        <ul id="manager-desks"></ul>
        <p class="helper" id="id-hint"></p>
      </section>

      <!-- Fleet dashboards -->
      <section class="section card">
        <header class="title"><h3>Fleet usage dashboards</h3></header>

        <div class="chart-grid">

          <div class="chart-tile">
            <div class="flex between">
              <strong>Posture mix</strong>
              <span class="pill" id="mgr-total-min">--</span>
            </div>

            <div id="mgr-donut" class="donut">
              <div class="donut-center">
                <strong id="mgr-stand-pct">0%</strong>
                <span class="helper">standing</span>
              </div>
            </div>

            <div class="legend">
              <span><span class="dot sitting"></span> Sitting <span id="mgr-sit-pct">0%</span></span>
              <span><span class="dot standing"></span> Standing <span id="mgr-stand-legend">0%</span></span>
            </div>
          </div>

          <div class="chart-tile">
            <div class="flex between">
              <strong>Top active desks</strong>
              <span class="pill" id="mgr-top-count">--</span>
            </div>

            <div class="spark-bars compact" id="mgr-bars"></div>
            <p class="helper">Highest total usage today.</p>
          </div>

          <div class="chart-tile">
            <div class="flex between">
              <strong>Movement quality</strong>
              <span class="pill" id="mgr-moves">--</span>
            </div>

            <div class="insight">
              <span class="label">Standing share</span>
              <div class="value" id="mgr-stand-share">--</div>
            </div>

            <div class="insight">
              <span class="label">Total desk time</span>
              <div class="value" id="mgr-total-time">--</div>
            </div>
          </div>

        </div>
      </section>

      <!-- Create desk -->
      <section class="section card">
        <header class="title"><h3>Add a desk</h3></header>

        <div class="grid two">
          <label class="field">
            <span>Name</span>
            <input id="desk-name" class="input" placeholder="DESK 1234">
          </label>

          <label class="field">
            <span>External ID</span>
            <input id="desk-external" class="input">
          </label>
        </div>

        <div class="grid two">
          <label class="field">
            <span>Manufacturer</span>
            <input id="desk-mfr" class="input">
          </label>

          <label class="field">
            <span>Height (cm)</span>
            <input id="desk-height" type="number" class="input">
          </label>
        </div>

        <button class="btn" id="btn-create-desk">Create desk</button>
        <p class="helper" id="manager-hint"></p>
      </section>

      <!-- Sync -->
      <section class="section card">
        <header class="title"><h3>Desk synchronization</h3></header>

        <div class="grid two">
          <label class="field">
            <span>Target height (cm)</span>
            <input id="sync-height" type="number" class="input" value="105">
          </label>

          <div class="field">
            <span>Actions</span>
            <button class="btn" id="btn-sync-desks">Sync all desks</button>
            <p class="helper" id="sync-status"></p>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    /* ---------- bootstrap ---------- */
    initThemeToggle();

    const token = localStorage.getItem('token');
    if (!token) location.href = 'index.html';

    const authHeaders = () => ({ Authorization: `Bearer ${token}` });

    document.querySelectorAll('[data-logout]').forEach(btn =>
      btn.addEventListener('click', logout)
    );

    /* ---------- dom ---------- */
    const els = {
      list: document.getElementById('manager-desks'),
      status: document.getElementById('manager-status'),
      hint: document.getElementById('id-hint'),
      donut: document.getElementById('mgr-donut'),
      standPct: document.getElementById('mgr-stand-pct'),
      sitPct: document.getElementById('mgr-sit-pct'),
      standLegend: document.getElementById('mgr-stand-legend'),
      totalMin: document.getElementById('mgr-total-min'),
      bars: document.getElementById('mgr-bars'),
      topCount: document.getElementById('mgr-top-count'),
      moves: document.getElementById('mgr-moves'),
      standShare: document.getElementById('mgr-stand-share'),
      totalTime: document.getElementById('mgr-total-time'),
    };

    let highlightId = null;

    /* ---------- api ---------- */
    const api = {
      async getDesks() {
        const res = await fetch('/api/desks', { headers: authHeaders() });
        if (!res.ok) throw new Error();
        return res.json();
      },

      async deleteDesk(id) {
        return fetch(`/api/desks/${id}`, {
          method: 'DELETE',
          headers: authHeaders()
        });
      }
    };

    /* ---------- render ---------- */
    function renderDesks(desks) {
      els.status.textContent = `Found ${desks.length} desks.`;
      els.list.innerHTML = '';

      desks.forEach(d => {
        const li = document.createElement('li');
        li.textContent = `Desk #${d.id} – ${d.name || 'Unnamed'}`;

        if (highlightId === d.id) {
          li.classList.add('desk-flash');
          setTimeout(() => li.classList.remove('desk-flash'), 1500);
        }

        const del = document.createElement('button');
        del.className = 'btn secondary';
        del.textContent = 'Delete';
        del.onclick = async () => {
          await api.deleteDesk(d.id);
          load();
        };

        li.appendChild(del);
        els.list.appendChild(li);
      });
    }

    function renderUsage(desks) {
      const sit = desks.reduce((s, d) => s + (d.sitting_minutes || 0), 0);
      const stand = desks.reduce((s, d) => s + (d.standing_minutes || 0), 0);
      const total = sit + stand || 1;

      const standPct = Math.round((stand / total) * 100);

      els.donut.style.background =
        `conic-gradient(#22c55e 0 ${standPct}%, #f97316 ${standPct}% 100%)`;

      els.standPct.textContent = `${standPct}%`;
      els.standLegend.textContent = `${standPct}%`;
      els.sitPct.textContent = `${100 - standPct}%`;
      els.totalMin.textContent = `${sit + stand} min`;
      els.standShare.textContent = `${standPct}%`;
      els.totalTime.textContent = `${sit + stand} min`;
    }

    /* ---------- actions ---------- */
    async function load() {
      try {
        const desks = await api.getDesks();
        renderDesks(desks);
        renderUsage(desks);
        highlightId = null;
      } catch {
        els.status.textContent = 'Failed to load desks.';
      }
    }

    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST', headers: authHeaders() });
      } finally {
        localStorage.removeItem('token');
        location.href = 'index.html';
      }
    }

    document.getElementById('btn-refresh').onclick = load;

    load();
  </script>
</body>
</html>
