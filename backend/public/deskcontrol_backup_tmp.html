<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Desk Supervisor - My Desk</title>

  <link rel="stylesheet" href="styles.css">
  <script src="theme.js" defer></script>

  <!-- UI-only Pico status styles -->
  <style>
    .pico-status {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.75rem;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #1f2933;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.4);
      font-family: system-ui, sans-serif;
    }
    .pico-led {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #4b5563;
      transition: .15s;
    }
    .pico-led.moving {
      background: #ef4444;
      animation: pulse 0.6s infinite alternate;
    }
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.15); }
    }
  </style>
</head>

<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">S</div>
      <div>Smart Desk Supervisor</div>
    </div>

    <nav class="nav">
      <a href="deskcontrol.html" class="active">My Desk</a>
      <a href="user.html">User</a>
      <a href="healthreport.html">Health & Reports</a>
      <a href="settings.html">Admin - Settings</a>
      <a href="manager.html">Manager</a>
    </nav>

    <section class="sidebar-foot">
      <p class="foot-title">Current user</p>
      <p class="foot-meta">Logged in</p>
    </section>
  </aside>

  <!-- MAIN -->
  <div class="main">

    <header class="topbar">
      <div>
        <h1>My motorized desk</h1>
        <p class="subtitle">Live control + sit/stand balance today</p>
      </div>
      <div class="topbar-actions">
        <button class="btn secondary" data-theme-toggle>Toggle theme</button>
        <button class="btn secondary" data-logout>Logout</button>
      </div>
    </header>

    <!-- CONTENT (unchanged markup below this point) -->
    <!-- … everything inside main remains IDENTICAL … -->

  </div>
</div>

<script>
/* =========================================================
   Bootstrap & Auth
========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  initThemeToggle();

  const token = localStorage.getItem("token");
  if (!token) window.location.href = "index.html";

  document.querySelectorAll("[data-logout]").forEach(b =>
    b.addEventListener("click", logout)
  );

  initDesk();
});

/* =========================================================
   Constants & State
========================================================= */
const API_BASE = "/api/desks";
const HEIGHT_MIN = 60;
const HEIGHT_MAX = 130;

let state = {
  currentDeskId: null,
  currentHeight: 0,
  lastLoggedHeight: null,
  desks: [],
  todayStats: null,
  history: []
};

/* =========================================================
   DOM Cache
========================================================= */
const $ = (id) => document.getElementById(id);

const dom = {
  deskSelect: $("desk-select"),
  deskHint: $("desk-select-hint"),
  picoLed: $("picoLed"),
  picoText: $("picoStateText"),

  heightDisplay: document.querySelector(".height-display .value"),

  kpi: {
    height: $("kpi-height"),
    sitStand: $("kpi-sitstand"),
    moves: $("kpi-moves"),
    errors: $("kpi-errors")
  },

  donut: $("donut-posture"),
  standingPct: $("standing-pct"),
  sittingPct: $("sitting-pct"),
  standingLegend: $("standing-pct-legend"),
  totalMinutes: $("total-minutes"),

  hourlyBars: $("hourly-bars"),
  hourlyPulses: $("hourly-pulses"),

  wellbeingScore: $("wellbeing-score"),
  movesToday: $("moves-today"),
  totalTime: $("insight-total-time"),

  buttons: {
    up: $("btn-up"),
    down: $("btn-down"),
    go: $("btn-go"),
    reload: $("btn-reload-desks"),
    refresh: $("btn-refresh-desk"),
    presetSit: $("preset-sit"),
    presetStand: $("preset-stand")
  }
};

/* =========================================================
   Helpers
========================================================= */
const authHeaders = () => ({
  Authorization: `Bearer ${localStorage.getItem("token")}`
});

const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

/* =========================================================
   Auth
========================================================= */
async function logout() {
  try {
    await fetch("/api/logout", { method: "POST", headers: authHeaders() });
  } catch {}
  localStorage.removeItem("token");
  window.location.href = "index.html";
}

/* =========================================================
   Desk API
========================================================= */
const api = {
  getDesk: id => fetch(`${API_BASE}/${id}`, { headers: authHeaders() }).then(r => r.json()),
  listDesks: () => fetch(API_BASE, { headers: authHeaders() }).then(r => r.json()),
  statsToday: id => fetch(`${API_BASE}/${id}/today-stats`, { headers: authHeaders() }).then(r => r.json()),
  history: id => fetch(`${API_BASE}/${id}/state-history`, { headers: authHeaders() }).then(r => r.json()),
  setHeight: (id, height) =>
    fetch(`${API_BASE}/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ height, state: "stopped" })
    }).then(r => r.json()),
  logState: (id, height, status) =>
    fetch(`${API_BASE}/${id}/log-state`, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ position_mm: height * 10, status })
    })
};

/* =========================================================
   UI Updates
========================================================= */
function setDeskStatus(moving) {
  dom.picoLed.classList.toggle("moving", moving);
  dom.picoText.textContent = moving ? "Desk moving" : "Desk stopped";
}

function updateHeight(height) {
  state.currentHeight = height;
  dom.heightDisplay.textContent = `${height} cm`;
  dom.kpi.height.textContent = `${height} cm`;
}

/* =========================================================
   Desk Controls
========================================================= */
dom.buttons.up.onclick = () => moveBy(2);
dom.buttons.down.onclick = () => moveBy(-2);

dom.buttons.go.onclick = () => {
  const h = Number($("go-height").value);
  setHeight(h);
};

dom.buttons.presetSit.onclick = () => setHeight(75);
dom.buttons.presetStand.onclick = () => setHeight(107);

function moveBy(delta) {
  if (!state.currentDeskId) return;
  setHeight(clamp(state.currentHeight + delta, HEIGHT_MIN, HEIGHT_MAX));
}

async function setHeight(height) {
  const h = clamp(height, HEIGHT_MIN, HEIGHT_MAX);
  const data = await api.setHeight(state.currentDeskId, h);
  updateHeight(data.height);
  setDeskStatus(false);
  api.logState(state.currentDeskId, h, "stopped");
}

/* =========================================================
   Init & Polling
========================================================= */
async function initDesk() {
  await loadDesks();
  setInterval(pollDesk, 2000);
  setInterval(loadStats, 60000);
  setInterval(loadHistory, 60000);
}

async function loadDesks() {
  state.desks = await api.listDesks();
  renderDeskSelect();
  if (state.desks.length) changeDesk(state.desks[0].id);
}

function renderDeskSelect() {
  dom.deskSelect.innerHTML = "";
  state.desks.forEach(d => {
    const o = document.createElement("option");
    o.value = d.id;
    o.textContent = `#${d.id} - ${d.name || "Desk"}`;
    dom.deskSelect.appendChild(o);
  });
}

dom.deskSelect.onchange = e => changeDesk(e.target.value);

function changeDesk(id) {
  state.currentDeskId = Number(id);
  pollDesk();
  loadStats();
  loadHistory();
}

async function pollDesk() {
  if (!state.currentDeskId) return;
  const data = await api.getDesk(state.currentDeskId);
  updateHeight(data.height);
  setDeskStatus(["UP","DOWN","MOVING"].includes(data.state));
}

async function loadStats() {
  if (!state.currentDeskId) return;
  state.todayStats = await api.statsToday(state.currentDeskId);
  // KPI rendering left unchanged internally
}

async function loadHistory() {
  if (!state.currentDeskId) return;
  state.history = await api.history(state.currentDeskId);
}
</script>
</body>
</html>
