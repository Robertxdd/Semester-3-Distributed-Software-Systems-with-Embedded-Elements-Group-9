<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Desk Supervisor - Admin Settings</title>
  <link rel="stylesheet" href="styles.css">
  <script src="theme.js"></script>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true">S</div>
        <div>Smart Desk Supervisor</div>
      </div>

      <nav class="nav" aria-label="Primary navigation">
        <a href="deskcontrol.html">
          <span>My Desk</span>
        </a>
        <a href="user.html">
          <span>User desk page</span>
        </a>
        <a href="healthreport.html">
          <span>Health & Reports</span>
        </a>
        <a href="settings.html" class="active">
          <span>Admin - Settings</span>
        </a>
        <a href="manager.html">
          <span>Manager</span>
        </a>
      </nav>

      <section class="sidebar-foot">
        <p class="foot-title">Current user</p>
        <p class="foot-meta">Administrator</p>
        <p class="foot-meta small">Configuration saved via API.</p>
      </section>
    </aside>

    <!-- Main content -->
    <div class="main">
      <!-- Top bar -->
      <header class="topbar">
        <div class="topbar-left">
          <h1>System & admin settings</h1>
          <p class="subtitle">
            Admin-only settings stored via API.
          </p>
        </div>
        <div class="topbar-actions">
          <button class="btn secondary" type="button" data-theme-toggle>Toggle theme</button>
          <button class="btn secondary" type="button" data-logout>Logout</button>
        </div>
      </header>

      <!-- Grid: connectivity + roles -->
      <section class="grid">
        <!-- System mode & connectivity -->
        <section class="section card">
          <div class="title">
            <h3>WiFi2BLE & API configuration</h3>
            <p class="subtitle">
              Connection settings for the Desk REST API (simulator or real hardware).
            </p>
          </div>
          <div class="body">
            <form class="form" action="#">
              <div class="field">
                <label for="mode">System mode</label>
                <select id="mode" class="input">
                  <option>Development - Simulator only</option>
                  <option>Hybrid - Simulator + selected real desks</option>
                  <option>Production - Real desks only</option>
                </select>
              </div>

              <div class="field">
                <label for="base-url">Base URL</label>
                <input id="base-url" class="input" type="text" placeholder="http://127.0.0.1:8000/api/v2/">
              </div>

              <div class="field">
                <label for="api-key">API key</label>
                <input id="api-key" class="input" type="password" placeholder="Enter simulator API key">
                <p class="helper">
                  32-character key as described in the WiFi2BLE simulator README.
                </p>
              </div>

              <div class="field">
                <label for="poll-interval">Polling interval</label>
                <select id="poll-interval" class="input">
                  <option>5 s - Real-time feedback</option>
                  <option selected>10 s - Balanced</option>
                  <option>30 s - Low network usage</option>
                </select>
              </div>

              <div class="field">
                <label class="checkbox">
                  <input type="checkbox" checked>
                  <span>Enable health data collection (sit/stand counters, position)</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" checked>
                  <span>Anonymize user IDs in raw telemetry</span>
                </label>
              </div>

              <button class="btn" type="button" id="save-connection">Save connection settings</button>
              <p class="helper" id="connection-status" aria-live="polite"></p>
            </form>
          </div>
        </section>

        <!-- Roles & access control -->
        <section class="section card">
          <div class="title">
            <h3>User roles & access control</h3>
            <p class="subtitle">
              Snapshot fed from real desks to validate API connectivity.
            </p>
          </div>
          <div class="body table-wrap">
            <div class="helper" id="roles-helper">User list will be populated from the API (no fake rows).</div>
            <table class="table" id="roles-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>External ID</th>
                  <th>Location</th>
                </tr>
              </thead>
              <tbody id="roles-body"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- Grid: energy + data/privacy -->
      <section class="grid">
        <!-- Energy & power-saving policy -->
        <section class="section card">
          <div class="title">
            <h3>Energy & idle power-saving</h3>
            <p class="subtitle">
              Placeholder controls for power-saving policy.
            </p>
          </div>
          <div class="body">
            <form class="form" action="#">
              <div class="field">
                <label for="idle-timeout">Idle timeout</label>
                <select id="idle-timeout" class="input">
                  <option>5 minutes</option>
                  <option selected>10 minutes</option>
                  <option>15 minutes</option>
                  <option>30 minutes</option>
                </select>
              </div>

              <div class="field">
                <label for="wake-mode">Wake-up behavior</label>
                <select id="wake-mode" class="input">
                  <option selected>User interaction only (button / panel)</option>
                  <option>Any network command</option>
                </select>
              </div>

              <button class="btn" type="button" id="save-energy">Save energy policy</button>
              <p class="helper" id="energy-status" aria-live="polite"></p>
            </form>
          </div>
        </section>

        <!-- Data, privacy & retention -->
        <section class="section card">
          <div class="title">
            <h3>Data & privacy</h3>
            <p class="subtitle">
              Retention and privacy options will be wired to backend settings.
            </p>
          </div>
          <div class="body">
            <form class="form" action="#">
              <div class="field">
                <label for="retention">Usage data retention</label>
                <select id="retention" class="input">
                  <option>90 days</option>
                  <option selected>180 days</option>
                  <option>365 days</option>
                </select>
              </div>

              <div class="field">
                <label class="checkbox">
                  <input type="checkbox" checked>
                  <span>Store only aggregated health metrics for reports</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" checked>
                  <span>Mask desk IDs in exported reports</span>
                </label>
              </div>

              <button class="btn" type="button" id="save-data">Save data settings</button>
              <p class="helper" id="data-status" aria-live="polite"></p>
            </form>
          </div>
        </section>
      </section>
    </div>
  </div>
</body>
<script>
  initThemeToggle();
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = 'index.html';
  }

  async function logout() {
    try {
      if (token) {
        await fetch('/api/logout', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
      }
    } catch (err) {
      console.warn('Logout failed', err);
    }
    localStorage.removeItem('token');
    window.location.href = 'index.html';
  }
  document.querySelectorAll('[data-logout]').forEach(btn => btn.addEventListener('click', logout));

  const authHeaders = () => {
    const token = localStorage.getItem('token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
  };

  const setStatus = (id, msg, ok = true) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? '#a7f3d0' : '#fca5a5';
  };

  const fetchSettings = async () => {
    try {
      const res = await fetch('/api/admin/settings', { headers: { 'Authorization': `Bearer ${token}` } });
      if (!res.ok) throw new Error(`Load settings failed: ${res.status}`);
      const data = await res.json();
      const conn = data.connection_settings || {};
      if (conn.mode) document.getElementById('mode').value = conn.mode;
      if (conn.base_url) document.getElementById('base-url').value = conn.base_url;
      if (conn.api_key) document.getElementById('api-key').value = conn.api_key;
      if (conn.poll_interval) document.getElementById('poll-interval').value = conn.poll_interval;

      const energy = data.energy_settings || {};
      if (energy.idle_timeout) document.getElementById('idle-timeout').value = energy.idle_timeout;
      if (energy.wake_mode) document.getElementById('wake-mode').value = energy.wake_mode;

      const privacy = data.data_settings || {};
      if (privacy.retention) document.getElementById('retention').value = privacy.retention;
      setStatus('connection-status', 'Loaded from API.');
    } catch (err) {
      console.error(err);
      setStatus('connection-status', 'Failed to load from API, using defaults.', false);
    }
  };

  const saveSettings = async (payload, key, statusId) => {
    try {
      const res = await fetch('/api/admin/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', ...authHeaders() },
        body: JSON.stringify({ [key]: payload }),
      });
      if (!res.ok) throw new Error(`Save failed: ${res.status}`);
      setStatus(statusId, 'Saved via API.');
    } catch (err) {
      console.error(err);
      setStatus(statusId, 'Failed to save via API.', false);
    }
  };

  document.getElementById('save-connection').onclick = async () => {
    const payload = {
      mode: document.getElementById('mode').value,
      base_url: document.getElementById('base-url').value,
      api_key: document.getElementById('api-key').value,
      poll_interval: document.getElementById('poll-interval').value,
      health_collection: true,
      anonymize: true,
    };
    await saveSettings(payload, 'connection_settings', 'connection-status');
  };

  document.getElementById('save-energy').onclick = () => {
    const payload = {
      idle_timeout: document.getElementById('idle-timeout').value,
      wake_mode: document.getElementById('wake-mode').value,
    };
    saveSettings(payload, 'energy_settings', 'energy-status');
  };

  document.getElementById('save-data').onclick = () => {
    const payload = {
      retention: document.getElementById('retention').value,
      aggregated_only: true,
      mask_ids: true,
    };
    saveSettings(payload, 'data_settings', 'data-status');
  };

  const updateRolesCard = async () => {
    const helper = document.getElementById('roles-helper');
    const body = document.getElementById('roles-body');
    if (body) body.innerHTML = '';
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        helper.textContent = 'No token stored; login to load data.';
        if (body) body.innerHTML = '<tr><td colspan="4">Not authenticated.</td></tr>';
        return;
      }
      const res = await fetch('/api/users', { headers: { 'Authorization': `Bearer ${token}` } });
      if (!res.ok) {
        helper.textContent = `API reachable, but returned ${res.status}.`;
        if (body) body.innerHTML = `<tr><td colspan="4">Error ${res.status}</td></tr>`;
        return;
      }
      const users = await res.json();
      helper.textContent = `API reachable. Users available: ${users.length}.`;
      if (body) {
        if (!users.length) {
          body.innerHTML = '<tr><td colspan="4">No users available.</td></tr>';
        } else {
          users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${u.id}</td>
              <td>${u.name || 'User'} (${u.email || 'n/a'})</td>
              <td>${u.role || (u.is_admin ? 'ADMIN' : 'OCCUPANT')}</td>
              <td>${u.is_admin ? 'Admin' : 'User'}</td>
            `;
            body.appendChild(tr);
          });
        }
      }
    } catch (err) {
      console.error(err);
      helper.textContent = 'Failed to reach API.';
      if (body) body.innerHTML = '<tr><td colspan="4">Failed to load desks.</td></tr>';
    }
  };

  fetchSettings();
  updateRolesCard();
</script>
</html>
