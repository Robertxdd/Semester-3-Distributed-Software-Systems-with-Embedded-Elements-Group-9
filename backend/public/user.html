<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>User Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="theme.js"></script>
</head>

<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">S</div>
      <div>Smart Desk Supervisor</div>
    </div>

    <nav class="nav">
      <a href="user.html" class="active">User Dashboard</a>
      <a href="healthreport.html">Health & Reports</a>
      <a href="index.html">Logout</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">

    <!-- Topbar -->
    <header class="topbar">
      <div>
        <h1>User Overview</h1>
        <p class="subtitle">Daily posture balance and desk control</p>
      </div>
      <div class="topbar-actions">
        <button class="btn secondary" data-theme-toggle>Toggle theme</button>
        <button class="btn secondary" data-logout>Logout</button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="kpis">
      <article class="card kpi"><h2>Standing</h2><p id="standing">0 min</p></article>
      <article class="card kpi"><h2>Sitting</h2><p id="sitting">0 min</p></article>
      <article class="card kpi"><h2>Movements</h2><p id="moves">0</p></article>
      <article class="card kpi"><h2>Health</h2><p id="score">0 / 100</p></article>
    </section>

    <!-- Balance -->
    <section class="section card">
      <h3>Sit / Stand balance</h3>

      <div class="chart-tile">
        <div id="donut" class="donut">
          <div class="donut-center">
            <strong id="standPct">0%</strong>
            <span class="helper">standing</span>
          </div>
        </div>

        <div class="legend">
          <div><span class="dot sitting"></span> Sitting <span id="sitPct">0%</span></div>
          <div><span class="dot standing"></span> Standing <span id="standLegend">0%</span></div>
        </div>
      </div>
    </section>

    <!-- Controls -->
    <section class="section card">
      <h3>Quick desk controls</h3>

      <div class="desk-controls">
        <div class="height-display">
          <span>Current height</span>
          <strong id="height">-- cm</strong>
        </div>

        <div class="control-buttons">
          <button class="btn secondary" id="down">Down</button>
          <button class="btn secondary" id="up">Up</button>
          <button class="btn" id="sit">Sit</button>
          <button class="btn" id="stand">Stand</button>
        </div>
      </div>
    </section>

    <!-- History -->
    <section class="section card">
      <h3>Recent desk states</h3>

      <table class="table compact">
        <thead>
          <tr><th>When</th><th>Height</th><th>Status</th></tr>
        </thead>
        <tbody id="history"></tbody>
      </table>
    </section>

  </main>
</div>

<script>
  initThemeToggle();

  const $ = id => document.getElementById(id);
  const token = localStorage.getItem("token");
  if (!token) location.href = "index.html";

  const API = "/api";
  let deskId, height = 0;

  const el = ["standing","sitting","moves","score","donut","standPct","standLegend","sitPct","history","height"]
    .reduce((o,k)=>(o[k]=$(k),o),{});

  const headers = { Authorization: `Bearer ${token}` };
  const json = u => fetch(u,{headers}).then(r=>r.ok?r.json():Promise.reject());

  const requireUser = async () => {
    const res = await fetch("/api/auth/me", { headers });
    if (!res.ok) {
      localStorage.removeItem("token");
      location.href = "index.html";
      return null;
    }
    const me = await res.json();
    if (me.is_admin) {
      location.href = "deskcontrol.html";
      return null;
    }
    return me;
  };

  const renderStats = s => {
    const stand=s.standing_minutes||0, sit=s.sitting_minutes||0, mv=s.movements_today||0;
    const pct=Math.round((stand/(stand+sit||1))*100);

    el.standing.textContent=`${stand} min`;
    el.sitting.textContent=`${sit} min`;
    el.moves.textContent=mv;
    el.score.textContent=`${Math.round(pct*0.8+mv*2)} / 100`;

    el.donut.style.background=`conic-gradient(#22c55e 0 ${pct}%, #f97316 ${pct}% 100%)`;
    el.standPct.textContent=el.standLegend.textContent=`${pct}%`;
    el.sitPct.textContent=`${100-pct}%`;
  };

  const renderHistory = h =>
    el.history.innerHTML = h.length
      ? h.slice(-8).map(i=>`
        <tr>
          <td>${i.collected_at||i.created_at}</td>
          <td>${i.position_mm?Math.round(i.position_mm/10):"n/a"}</td>
          <td>${i.status||""}</td>
        </tr>`).join("")
      : "<tr><td colspan='3'>No history</td></tr>";

  const setHeight = async h => {
    h=Math.min(Math.max(h,60),130);
    await fetch(`${API}/desks/${deskId}`,{
      method:"PUT",
      headers:{...headers,"Content-Type":"application/json"},
      body:JSON.stringify({height:h})
    });
    loadHeight();
  };

  const loadHeight = async () => {
    const d=await json(`${API}/desks/${deskId}`);
    height=d.height;
    el.height.textContent=`${height} cm`;
  };

  const led = d => fetch("http://127.0.0.1:5055/led/on",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({direction:d})
  }).catch(()=>{});

  $("up").onclick=()=>{led("up");setHeight(height+2)};
  $("down").onclick=()=>{led("down");setHeight(height-2)};
  $("sit").onclick=()=>setHeight(75);
  $("stand").onclick=()=>setHeight(107);

  const logout = async () => {
    try {
      await fetch("/api/logout", { method: "POST", headers });
    } finally {
      localStorage.removeItem("token");
      location.href = "index.html";
    }
  };

  document.querySelectorAll("[data-logout]").forEach(b => b.onclick = logout);

  (async()=>{
    const me = await requireUser();
    if (!me) return;
    const desks=await json(`${API}/desks`);
    if(!desks.length) {
      el.height.textContent = "-- cm";
      el.history.innerHTML = "<tr><td colspan='3'>No desks available</td></tr>";
      document.querySelectorAll(".control-buttons .btn").forEach(b => b.disabled = true);
      return;
    }
    deskId=desks[0].id;

    renderStats(await json(`${API}/desks/${deskId}/today-stats`));
    renderHistory(await json(`${API}/desks/${deskId}/state-history`));
    await loadHeight();
    setInterval(loadHeight,5000);
  })();
</script>
</body>
</html>
