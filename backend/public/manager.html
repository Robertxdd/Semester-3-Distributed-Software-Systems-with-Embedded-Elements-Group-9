<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manager - Work in progress</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">S</div>
        <div>Smart Desk Supervisor</div>
      </div>
      <nav class="nav">
        <a href="deskcontrol.html"><span>My Desk</span></a>
        <a href="healthreport.html"><span>Health & Reports</span></a>
        <a href="settings.html"><span>Admin - Settings</span></a>
        <a href="manager.html" class="active"><span>Manager</span></a>
      </nav>
    </aside>

    <div class="main">
      <header class="topbar">
        <div class="topbar-left">
          <h1>Manager view</h1>
          <p class="subtitle">Admin-only area with desk registry and quick actions.</p>
        </div>
        <div class="topbar-right">
          <span class="pill">Work in progress</span>
        </div>
      </header>

      <section class="section card">
        <div class="title"><h3>Registered desks</h3></div>
        <div class="body">
          <div class="toolbar">
            <p id="manager-status">Loading desks...</p>
            <button class="btn secondary" id="btn-refresh" type="button">Refresh</button>
          </div>
          <ul id="manager-desks"></ul>
          <p class="helper" id="id-hint"></p>
        </div>
      </section>

      <section class="section card">
        <div class="title"><h3>Add a desk</h3></div>
        <div class="body">
          <div class="grid two">
            <label class="field">
              <span>Name</span>
              <input id="desk-name" class="input" type="text" placeholder="DESK 9999">
            </label>
            <label class="field">
              <span>External ID</span>
              <input id="desk-external" class="input" type="text" placeholder="aa:bb:cc:dd:ee:ff">
            </label>
          </div>
          <div class="grid two">
            <label class="field">
              <span>Manufacturer</span>
              <input id="desk-mfr" class="input" type="text" placeholder="Desk-O-Matic Co.">
            </label>
            <label class="field">
              <span>Height (cm)</span>
              <input id="desk-height" class="input" type="number" placeholder="0">
            </label>
          </div>
          <button class="btn" id="btn-create-desk" type="button">Create desk</button>
          <p class="helper" id="manager-hint">Creates via POST /api/desks.</p>
        </div>
      </section>
    </div>
  </div>

  <script>
    const authHeaders = () => {
      const token = localStorage.getItem('token');
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    };

    let newDeskHighlightId = null;

    function renderDesks(desks) {
      const status = document.getElementById('manager-status');
      const list = document.getElementById('manager-desks');
      status.textContent = `Found ${desks.length} desks.`;
      list.innerHTML = '';
      const hint = document.getElementById('id-hint');
      const hasDesk1 = desks.some(d => d.id === 1);
      hint.textContent = hasDesk1
        ? 'Desk #1 is present.'
        : 'Desk #1 no longer exists (was deleted). IDs are auto-increment; new desks keep growing.';

      desks.forEach(d => {
        const li = document.createElement('li');
        li.textContent = `Desk #${d.id} (${d.name || 'No name'})` + (d.external_id ? ` - External: ${d.external_id}` : '');

        if (newDeskHighlightId && d.id === newDeskHighlightId) {
          li.classList.add('desk-flash');
          setTimeout(() => li.classList.remove('desk-flash'), 1600);
        }

        const remove = document.createElement('button');
        remove.textContent = 'Delete';
        remove.className = 'btn secondary';
        remove.onclick = async () => {
          try {
            const res = await fetch(`/api/desks/${d.id}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json', ...authHeaders() }
            });
            if (res.ok) {
              loadDesks();
            } else {
              alert(`Failed to delete desk (#${d.id})`);
            }
          } catch (err) {
            console.error(err);
            alert('Network error deleting desk');
          }
        };

        li.appendChild(remove);
        list.appendChild(li);
      });
    }

    async function loadDesks() {
      try {
        const res = await fetch('/api/desks', { headers: authHeaders() });
        if (!res.ok) throw new Error(`List failed: ${res.status}`);
        const desks = await res.json();
        renderDesks(desks);
        newDeskHighlightId = null;
      } catch (err) {
        console.error(err);
        document.getElementById('manager-status').textContent = 'Failed to load desks';
        document.getElementById('id-hint').textContent = '';
      }
    }

    async function createDesk() {
      const name = document.getElementById('desk-name').value.trim();
      const external_id = document.getElementById('desk-external').value.trim();
      const manufacturer = document.getElementById('desk-mfr').value.trim();
      const height = document.getElementById('desk-height').value;

      if (!name) {
        alert('Name is required');
        return;
      }

      const body = { name };
      if (external_id) body.external_id = external_id;
      if (manufacturer) body.manufacturer = manufacturer;
      if (height) body.height = Number(height);

      try {
        const res = await fetch('/api/desks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || 'Failed to create desk');
        }

        try {
          const created = await res.json();
          if (created && created.id) {
            newDeskHighlightId = created.id;
          }
        } catch (_) {
          newDeskHighlightId = null;
        }

        document.getElementById('manager-hint').textContent = 'Desk created.';
        document.getElementById('desk-name').value = '';
        document.getElementById('desk-external').value = '';
        document.getElementById('desk-mfr').value = '';
        document.getElementById('desk-height').value = '';
        loadDesks();
      } catch (err) {
        console.error(err);
        alert('Error creating desk: ' + err.message);
      }
    }

    document.getElementById('btn-create-desk').onclick = createDesk;
    document.getElementById('btn-refresh').onclick = loadDesks;
    loadDesks();
  </script>
</body>
</html>
